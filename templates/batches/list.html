{% extends 'base.html' %}
{% from 'relief_requests/_summary_cards.html' import render_summary_cards %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relief-requests-ui.css') }}">
{% endblock %}

{% block title %}Batch Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header with Action Button -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="page-header mb-0">
            <div class="page-title">
                <i class="bi bi-layers page-title-icon"></i>
                <h1 class="page-title-text">Batch Management</h1>
            </div>
        </div>
        <a href="{{ url_for('batches.create_batch') }}" class="btn-relief-primary">
            <i class="bi bi-plus-circle"></i>
            Create Batch
        </a>
    </div>

    <!-- Summary Metrics -->
    {% set summary_metrics = [
        {
            'icon': 'layers',
            'label': 'Total Batches',
            'value': total_batches,
            'variant': 'info'
        },
        {
            'icon': 'check-circle',
            'label': 'Active',
            'value': active_batches,
            'variant': 'success'
        },
        {
            'icon': 'exclamation-triangle',
            'label': 'Expiring Soon',
            'value': expiring_soon_count,
            'variant': 'warning'
        },
        {
            'icon': 'x-circle',
            'label': 'Expired',
            'value': expired_count,
            'variant': 'danger'
        },
        {
            'icon': 'box',
            'label': 'Available Qty',
            'value': '{:,.2f}'.format(total_available),
            'variant': 'primary'
        }
    ] %}
    {{ render_summary_cards(summary_metrics) }}

    <!-- Filter Tabs -->
    <nav class="filter-tabs" role="navigation" aria-label="Batch status filters">
        <a href="{{ url_for('batches.list_batches', status='active', warehouse=warehouse_filter, item=item_filter, search=search_query) }}" 
           class="filter-tab {% if status_filter == 'active' or not status_filter %}active{% endif %}"
           aria-current="{% if status_filter == 'active' or not status_filter %}page{% endif %}">
            Active Batches
            {% if active_batches > 0 %}
            <span class="filter-tab-count" aria-label="{{ active_batches }} active">{{ active_batches }}</span>
            {% endif %}
        </a>
        <a href="{{ url_for('batches.list_batches', status='expiring_soon', warehouse=warehouse_filter, item=item_filter, search=search_query) }}" 
           class="filter-tab {% if status_filter == 'expiring_soon' %}active{% endif %}"
           aria-current="{% if status_filter == 'expiring_soon' %}page{% endif %}">
            Expiring Soon
            {% if expiring_soon_count > 0 %}
            <span class="filter-tab-count" aria-label="{{ expiring_soon_count }} expiring soon">{{ expiring_soon_count }}</span>
            {% endif %}
        </a>
        <a href="{{ url_for('batches.list_batches', status='expired', warehouse=warehouse_filter, item=item_filter, search=search_query) }}" 
           class="filter-tab {% if status_filter == 'expired' %}active{% endif %}"
           aria-current="{% if status_filter == 'expired' %}page{% endif %}">
            Expired
            {% if expired_count > 0 %}
            <span class="filter-tab-count" aria-label="{{ expired_count }} expired">{{ expired_count }}</span>
            {% endif %}
        </a>
        <a href="{{ url_for('batches.list_batches', status='unavailable', warehouse=warehouse_filter, item=item_filter, search=search_query) }}" 
           class="filter-tab {% if status_filter == 'unavailable' %}active{% endif %}"
           aria-current="{% if status_filter == 'unavailable' %}page{% endif %}">
            Unavailable
        </a>
        <a href="{{ url_for('batches.list_batches', status='all', warehouse=warehouse_filter, item=item_filter, search=search_query) }}" 
           class="filter-tab {% if status_filter == 'all' %}active{% endif %}"
           aria-current="{% if status_filter == 'all' %}page{% endif %}">
            All Batches
            {% if total_batches > 0 %}
            <span class="filter-tab-count" aria-label="{{ total_batches }} total">{{ total_batches }}</span>
            {% endif %}
        </a>
    </nav>

    <!-- Search and Filter Bar -->
    <div class="card mb-3">
        <div class="card-body p-3">
            <form method="GET" action="{{ url_for('batches.list_batches') }}" class="row g-2">
                <input type="hidden" name="status" value="{{ status_filter }}">
                
                <!-- Search Input -->
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               value="{{ search_query }}" 
                               placeholder="Search batch number, item name...">
                    </div>
                </div>

                <!-- Warehouse Filter -->
                <div class="col-md-3">
                    <select class="form-select" name="warehouse" id="warehouseFilter">
                        <option value="">All Warehouses</option>
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse.warehouse_id }}" {% if warehouse_filter == warehouse.warehouse_id %}selected{% endif %}>
                            {{ warehouse.warehouse_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Item Filter -->
                <div class="col-md-3">
                    <select class="form-select" name="item" id="itemFilter">
                        <option value="">All Items</option>
                        {% for item in items %}
                        <option value="{{ item.item_id }}" {% if item_filter == item.item_id %}selected{% endif %}>
                            {{ item.item_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filter Button -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-modern btn-primary w-100">
                        <i class="bi bi-funnel"></i>
                        Apply Filters
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Batches Table -->
    <div class="card">
        <div class="card-body">
            {% if batches %}
            <div class="table-responsive">
                <table class="table modern-table">
                    <thead>
                        <tr>
                            <th>Batch No.</th>
                            <th>Item</th>
                            <th>Warehouse</th>
                            <th class="text-end">Usable Qty</th>
                            <th class="text-end">Reserved</th>
                            <th class="text-end">Available</th>
                            <th>UOM</th>
                            <th>Batch Date</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for batch in batches %}
                        {% set available_qty = batch.usable_qty - batch.reserved_qty %}
                        {% set is_expired = batch.expiry_date and batch.expiry_date < now().date() %}
                        {% set days_until_expiry = (batch.expiry_date - now().date()).days if batch.expiry_date and not is_expired else None %}
                        
                        <tr>
                            <td>
                                <span class="code-pill">{{ batch.batch_no }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <div class="fw-medium">{{ batch.item.item_name }}</div>
                                        {% if batch.size_spec %}
                                        <small class="text-muted">{{ batch.size_spec }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>{{ batch.inventory.warehouse.warehouse_name }}</td>
                            <td class="text-end">{{ '{:,.2f}'.format(batch.usable_qty) }}</td>
                            <td class="text-end">{{ '{:,.2f}'.format(batch.reserved_qty) }}</td>
                            <td class="text-end">
                                <strong>{{ '{:,.2f}'.format(available_qty) }}</strong>
                            </td>
                            <td>{{ batch.uom_code }}</td>
                            <td>{{ batch.batch_date.strftime('%Y-%m-%d') if batch.batch_date else '—' }}</td>
                            <td>
                                {% if batch.expiry_date %}
                                    {% if is_expired %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i>
                                            {{ batch.expiry_date.strftime('%Y-%m-%d') }}
                                        </span>
                                    {% elif days_until_expiry and days_until_expiry <= 30 %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            {{ batch.expiry_date.strftime('%Y-%m-%d') }}
                                            ({{ days_until_expiry }}d)
                                        </span>
                                    {% else %}
                                        {{ batch.expiry_date.strftime('%Y-%m-%d') }}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if batch.status_code == 'A' %}
                                <span class="status-badge badge-success">Active</span>
                                {% else %}
                                <span class="status-badge badge-warning">Unavailable</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a href="{{ url_for('batches.view_batch', batch_id=batch.batch_id) }}" 
                                   class="btn btn-sm btn-outline-primary me-1"
                                   title="View details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('batches.edit_batch', batch_id=batch.batch_id) }}" 
                                   class="btn btn-sm btn-outline-secondary"
                                   title="Edit batch">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-layers text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3 mb-0">No batches found</p>
                <p class="text-muted small">Try adjusting your filters or create a new batch</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
