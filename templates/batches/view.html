{% extends 'base.html' %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/relief-requests-ui.css') }}">
{% endblock %}

{% block title %}Batch Details - {{ batch.batch_no }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="page-header mb-0">
            <div class="page-title">
                <i class="bi bi-layers page-title-icon"></i>
                <h1 class="page-title-text">Batch: {{ batch.batch_no }}</h1>
            </div>
        </div>
        <div>
            <a href="{{ url_for('batches.list_batches') }}" class="btn-relief-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            <a href="{{ url_for('batches.edit_batch', batch_id=batch.batch_id) }}" class="btn-relief-primary">
                <i class="bi bi-pencil"></i> Edit
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Details Card -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Batch Information</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Batch Number</label>
                            <div><span class="code-pill">{{ batch.batch_no }}</span></div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Status</label>
                            <div>
                                {% if batch.status_code == 'A' %}
                                <span class="status-badge badge-success">Active</span>
                                {% else %}
                                <span class="status-badge badge-warning">Unavailable</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Item</label>
                            <div class="fw-medium">{{ batch.item.item_name }}</div>
                            <small class="text-muted">{{ batch.item.item_code }}</small>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Warehouse</label>
                            <div class="fw-medium">{{ batch.inventory.warehouse.warehouse_name }}</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Batch Date</label>
                            <div>{{ batch.batch_date.strftime('%Y-%m-%d') if batch.batch_date else '—' }}</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Expiry Date</label>
                            <div>
                                {% if batch.expiry_date %}
                                    {% if is_expired %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i>
                                            {{ batch.expiry_date.strftime('%Y-%m-%d') }} (Expired)
                                        </span>
                                    {% elif days_until_expiry and days_until_expiry <= 30 %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            {{ batch.expiry_date.strftime('%Y-%m-%d') }}
                                        </span>
                                        <div><small class="text-muted">{{ days_until_expiry }} days remaining</small></div>
                                    {% else %}
                                        {{ batch.expiry_date.strftime('%Y-%m-%d') }}
                                        {% if days_until_expiry %}
                                        <div><small class="text-muted">{{ days_until_expiry }} days remaining</small></div>
                                        {% endif %}
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">No expiry date</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Verified</label>
                            <div>
                                {% if batch.verified_flag %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Yes</span>
                                {% else %}
                                <span class="badge bg-secondary"><i class="bi bi-x-circle"></i> No</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantities Card -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-boxes"></i> Quantities</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="text-muted small">Usable Qty</label>
                            <div class="fs-5 fw-medium">{{ '{:,.2f}'.format(batch.usable_qty) }}</div>
                            <small class="text-muted">{{ batch.uom_code }}</small>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Reserved</label>
                            <div class="fs-5 fw-medium text-warning">{{ '{:,.2f}'.format(batch.reserved_qty) }}</div>
                            <small class="text-muted">{{ batch.uom_code }}</small>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Available</label>
                            <div class="fs-5 fw-medium text-success">{{ '{:,.2f}'.format(available_qty) }}</div>
                            <small class="text-muted">{{ batch.uom_code }}</small>
                        </div>
                        <div class="col-md-3">
                            <label class="text-muted small">Avg Unit Value</label>
                            <div class="fs-5 fw-medium">${{ '{:,.2f}'.format(batch.avg_unit_value) }}</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Defective Qty</label>
                            <div>{{ '{:,.2f}'.format(batch.defective_qty) }} {{ batch.uom_code }}</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Expired Qty</label>
                            <div>{{ '{:,.2f}'.format(batch.expired_qty) }} {{ batch.uom_code }}</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted small">Size Specification</label>
                            <div>{{ batch.size_spec if batch.size_spec else '—' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comments Card -->
            {% if batch.comments %}
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-chat-text"></i> Comments</h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">{{ batch.comments }}</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Audit Information Card -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Audit Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Created By</label>
                        <div>{{ batch.create_by_id }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Created Date</label>
                        <div>{{ batch.create_dtime.strftime('%Y-%m-%d %H:%M:%S') if batch.create_dtime else '—' }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Last Updated By</label>
                        <div>{{ batch.update_by_id }}</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">Last Updated</label>
                        <div>{{ batch.update_dtime.strftime('%Y-%m-%d %H:%M:%S') if batch.update_dtime else '—' }}</div>
                    </div>
                    <div>
                        <label class="text-muted small">Version</label>
                        <div>{{ batch.version_nbr }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
