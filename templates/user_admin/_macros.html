{# User Management Macros - Reusable components for user administration pages #}

{# Status Badge - Displays user account status #}
{% macro status_badge(status, is_active=None) %}
    {% if status == 'locked' %}
        <span class="status-badge locked">
            <i class="bi bi-lock-fill"></i> Locked
        </span>
    {% elif status == 'pending' %}
        <span class="status-badge pending">
            <i class="bi bi-clock-fill"></i> Pending
        </span>
    {% elif status == 'active' or (status == None and is_active == True) %}
        <span class="status-badge active">
            <i class="bi bi-check-circle-fill"></i> Active
        </span>
    {% elif status == 'inactive' or (status == None and is_active == False) %}
        <span class="status-badge inactive">
            <i class="bi bi-x-circle-fill"></i> Inactive
        </span>
    {% else %}
        <span class="status-badge">{{ status }}</span>
    {% endif %}
{% endmacro %}

{# MFA Status Badge - Shows multi-factor authentication status #}
{% macro mfa_status_badge(enabled=False, verified=False) %}
    {% if enabled and verified %}
        <span class="security-badge mfa-enabled" title="Multi-factor authentication is active">
            <i class="bi bi-shield-fill-check"></i> MFA Enabled
        </span>
    {% elif enabled and not verified %}
        <span class="security-badge mfa-disabled" title="MFA setup incomplete">
            <i class="bi bi-shield-fill-exclamation"></i> MFA Pending
        </span>
    {% else %}
        <span class="security-badge mfa-disabled" title="Multi-factor authentication not enabled">
            <i class="bi bi-shield-fill-x"></i> No MFA
        </span>
    {% endif %}
{% endmacro %}

{# Access Tier Chip - Displays user's access level #}
{% macro access_tier_chip(tier='standard') %}
    {% if tier == 'full' or tier == 'administrator' %}
        <span class="access-tier-chip tier-full" title="Full system access">
            <i class="bi bi-star-fill"></i> Full Access
        </span>
    {% elif tier == 'standard' or tier == 'manager' %}
        <span class="access-tier-chip tier-standard" title="Standard access level">
            <i class="bi bi-person-check-fill"></i> Standard
        </span>
    {% elif tier == 'limited' %}
        <span class="access-tier-chip tier-limited" title="Limited access">
            <i class="bi bi-person-dash-fill"></i> Limited
        </span>
    {% elif tier == 'restricted' %}
        <span class="access-tier-chip tier-restricted" title="Restricted access">
            <i class="bi bi-person-x-fill"></i> Restricted
        </span>
    {% else %}
        <span class="access-tier-chip tier-standard">
            {{ tier|title }}
        </span>
    {% endif %}
{% endmacro %}

{# Role Badges - Display multiple role badges #}
{% macro role_badges(roles, max_display=3, admin_role_codes=['SYSTEM_ADMINISTRATOR', 'SYS_ADMIN']) %}
    {% if roles %}
        {% for role in roles[:max_display] %}
            {% if role.role_code in admin_role_codes %}
                <span class="role-badge admin" title="{{ role.role_desc or role.name }}">
                    <i class="bi bi-star-fill"></i> {{ role.name }}
                </span>
            {% elif 'MANAGER' in role.role_code or 'MANAGER' in role.name.upper() %}
                <span class="role-badge manager" title="{{ role.role_desc or role.name }}">
                    <i class="bi bi-diagram-3-fill"></i> {{ role.name }}
                </span>
            {% else %}
                <span class="role-badge" title="{{ role.role_desc or role.name }}">
                    {{ role.name }}
                </span>
            {% endif %}
        {% endfor %}
        {% if roles|length > max_display %}
            <span class="role-badge" style="background: #e9ecef; color: #495057;">
                +{{ roles|length - max_display }} more
            </span>
        {% endif %}
    {% else %}
        <span class="text-muted small">No roles assigned</span>
    {% endif %}
{% endmacro %}

{# Security Risk Indicator - Shows account security risk level #}
{% macro security_risk_indicator(risk_level='low', risk_factors=[]) %}
    {% if risk_level == 'high' %}
        <span class="security-badge high-risk" title="High security risk: {{ risk_factors|join(', ') if risk_factors else 'Multiple factors' }}">
            <i class="bi bi-exclamation-triangle-fill"></i> High Risk
        </span>
    {% elif risk_level == 'medium' %}
        <span class="security-badge password-expiring" title="Medium risk: {{ risk_factors|join(', ') if risk_factors else 'Some concerns' }}">
            <i class="bi bi-exclamation-circle-fill"></i> Medium Risk
        </span>
    {% else %}
        <span class="security-badge mfa-enabled" title="Low security risk">
            <i class="bi bi-check-circle-fill"></i> Low Risk
        </span>
    {% endif %}
{% endmacro %}

{# Compliance Alert - Display compliance-related messages #}
{% macro compliance_alert(type='info', title='', message='', icon='info-circle-fill') %}
    <div class="compliance-alert {{ type }}" role="alert">
        <div class="compliance-alert-icon">
            <i class="bi bi-{{ icon }}"></i>
        </div>
        <div class="compliance-alert-content">
            {% if title %}
                <div class="compliance-alert-title">{{ title }}</div>
            {% endif %}
            <p class="compliance-alert-message">{{ message }}</p>
        </div>
    </div>
{% endmacro %}

{# Metric Card - Reusable metric display card #}
{% macro metric_card(value, label, icon, variant='total-users', trend=None, trend_positive=True) %}
    <div class="metric-card-user">
        <div class="metric-icon-user {{ variant }}">
            <i class="bi bi-{{ icon }}"></i>
        </div>
        <div class="metric-content-user">
            <div class="metric-value-user">{{ value }}</div>
            <div class="metric-label-user">{{ label }}</div>
            {% if trend %}
                <div class="metric-trend {{ 'negative' if not trend_positive else '' }}">
                    <i class="bi bi-{{ 'arrow-up' if trend_positive else 'arrow-down' }}"></i>
                    {{ trend }}
                </div>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# Info Row - Display label-value pair #}
{% macro info_row(label, value='', badge=None, icon=None) %}
    <div class="info-row">
        <div class="info-label">
            {% if icon %}<i class="bi bi-{{ icon }}"></i> {% endif %}{{ label }}
        </div>
        <div class="info-value">
            {% if badge %}
                {{ badge }}
            {% else %}
                {{ value if value else '-' }}
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# Audit Timeline Event - Single audit log entry #}
{% macro audit_event(title, details, timestamp, event_type='info', icon='clock-history', meta=None) %}
    <div class="audit-event {{ event_type }}">
        <div class="audit-icon">
            <i class="bi bi-{{ icon }}"></i>
        </div>
        <div class="audit-event-content">
            <div class="audit-event-header">
                <div class="audit-event-title">{{ title }}</div>
                <div class="audit-event-time">{{ timestamp }}</div>
            </div>
            <div class="audit-event-details">{{ details }}</div>
            {% if meta %}
                <div class="audit-event-meta">{{ meta }}</div>
            {% endif %}
        </div>
    </div>
{% endmacro %}

{# Security Panel Item - Individual security setting display #}
{% macro security_item(label, value, status_badge=None) %}
    <div class="security-item">
        <div class="security-item-header">
            <span class="security-item-label">{{ label }}</span>
            {% if status_badge %}
                {{ status_badge }}
            {% endif %}
        </div>
        <div class="security-item-value">{{ value }}</div>
    </div>
{% endmacro %}

{# Last Login Display - Formatted last login time #}
{% macro last_login_display(last_login, never_text='Never logged in') %}
    {% if last_login %}
        <span title="{{ last_login.strftime('%Y-%m-%d %H:%M:%S') if last_login else '' }}">
            {% set diff = (now() - last_login).days if last_login else 0 %}
            {% if diff == 0 %}
                <span class="text-success"><i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Today</span>
            {% elif diff == 1 %}
                <span class="text-success">Yesterday</span>
            {% elif diff < 7 %}
                <span class="text-success">{{ diff }} days ago</span>
            {% elif diff < 30 %}
                <span class="text-warning">{{ (diff / 7)|round|int }} weeks ago</span>
            {% else %}
                <span class="text-danger">{{ (diff / 30)|round|int }} months ago</span>
            {% endif %}
        </span>
    {% else %}
        <span class="text-muted"><i class="bi bi-dash-circle"></i> {{ never_text }}</span>
    {% endif %}
{% endmacro %}

{# Action Button Group - Consistent action buttons #}
{% macro action_buttons(view_url=None, edit_url=None, delete_url=None, custom_buttons=[]) %}
    <div class="action-buttons-group">
        {% if view_url %}
            <a href="{{ view_url }}" class="btn-user-action" title="View details" aria-label="View user details">
                <i class="bi bi-eye"></i>
            </a>
        {% endif %}
        {% if edit_url %}
            <a href="{{ edit_url }}" class="btn-user-action" title="Edit user" aria-label="Edit user">
                <i class="bi bi-pencil"></i>
            </a>
        {% endif %}
        {% for button in custom_buttons %}
            <a href="{{ button.url }}" 
               class="btn-user-action {{ button.class if button.class else '' }}" 
               title="{{ button.title if button.title else '' }}"
               {% if button.confirm %}onclick="return confirm('{{ button.confirm }}');"{% endif %}>
                {% if button.icon %}<i class="bi bi-{{ button.icon }}"></i>{% endif %}
                {{ button.text if button.text else '' }}
            </a>
        {% endfor %}
        {% if delete_url %}
            <a href="{{ delete_url }}" 
               class="btn-user-action danger" 
               title="Delete user" 
               aria-label="Delete user"
               onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.');">
                <i class="bi bi-trash"></i>
            </a>
        {% endif %}
    </div>
{% endmacro %}

{# Empty State - Display when no data available #}
{% macro empty_state(title='No Data Available', message='', icon='inbox', action_url=None, action_text='Add New') %}
    <div class="text-center py-5">
        <div class="mb-3">
            <i class="bi bi-{{ icon }}" style="font-size: 4rem; color: #dee2e6;"></i>
        </div>
        <h5 class="text-muted">{{ title }}</h5>
        {% if message %}
            <p class="text-muted mb-3">{{ message }}</p>
        {% endif %}
        {% if action_url %}
            <a href="{{ action_url }}" class="btn-user-action primary">
                <i class="bi bi-plus-circle"></i> {{ action_text }}
            </a>
        {% endif %}
    </div>
{% endmacro %}

{# Password Strength Indicator - Visual password strength meter #}
{% macro password_strength_indicator(strength='weak') %}
    <div class="password-strength-meter mt-2">
        <div class="d-flex gap-1 mb-1">
            <div class="strength-bar flex-1 {{ 'bg-danger' if strength in ['weak', 'fair', 'good', 'strong'] else 'bg-light' }}"></div>
            <div class="strength-bar flex-1 {{ 'bg-warning' if strength in ['fair', 'good', 'strong'] else 'bg-light' }}"></div>
            <div class="strength-bar flex-1 {{ 'bg-info' if strength in ['good', 'strong'] else 'bg-light' }}"></div>
            <div class="strength-bar flex-1 {{ 'bg-success' if strength == 'strong' else 'bg-light' }}"></div>
        </div>
        <small class="
            {% if strength == 'weak' %}text-danger
            {% elif strength == 'fair' %}text-warning
            {% elif strength == 'good' %}text-info
            {% elif strength == 'strong' %}text-success
            {% else %}text-muted
            {% endif %}
        ">
            Password strength: {{ strength|title }}
        </small>
    </div>
    <style nonce="{{ csp_nonce() }}">
        .strength-bar {
            height: 4px;
            border-radius: 2px;
            transition: background-color 0.3s;
        }
        .flex-1 { flex: 1; }
    </style>
{% endmacro %}
