create table reliefrqst
(
              reliefrqst_id integer not null generated by default as identity
                             constraint pk_reliefrqst primary key,
              agency_id integer not null 
                             constraint fk_reliefrqst_agency references agency,
              request_date date not null
                             constraint c_reliefrqst_1 check (request_date <= CURRENT_DATE),

              --Randomly generated reference/tracking number for request
              tracking_no varchar(7) not null,
              
              --Optional event for which the request is being made. Note: If a request is being
              --made for an event for which the agency is not eligible, the request should be
              --prevented from being raised.

              eligible_event_id integer
                             constraint fk_reliefrqst_event references event,

              urgency_ind char(1) not null
                             --L=Low, M=Medium, H=High, C=Critical
                             constraint c_reliefrqst_2 check (urgency_ind in ('L','M','H','C')),

              --Optional notes related to request and review
              rqst_notes_text text,
              review_notes_text text,

              status_code smallint not null default 0
                             constraint fk_reliefrqst_reliefrqst_status references reliefrqst_status,

              --See relief status table for rules regarding status code and reason
              status_reason_desc varchar(255)
                             constraint c_reliefrqst_3
                             check ((status_reason_desc is not null)
                                           or (status_reason_desc is null and status_code not in (4,6,8)),

              --Creates/Cancels request
              create_by_id varchar(20) not null,
              create_dtime timestamp(0) without time zone not null,

              --Submits/Cancels request. Cancellation can be done by creator/reviewer
              review_by_id varchar(20)
                             constraint c_reliefrqst_4a
                             check ((review_by_id is null and status_code < 2)
                                           or (review_by_id is not null and status_code >= 2)),
              review_dtime timestamp(0) without time zone
                             constraint c_reliefrqst_4b
                             check ((review_by_id is null and review_dtime is null)
                                           or (review_by_id is not null and review_dtime is not null)),
              
              --Actions request - Fill, Part fill, Closes
              action_by_id varchar(20),
                             constraint c_reliefrqst_5a
                             check ((action_by_id is null and status_code < 4)
                                           or (action_by_id is not null and status_code >= 4)),
              action_dtime timestamp(0) without time zone,
                             constraint c_reliefrqst_5b
                             check ((action_by_id is null and action_dtime is null)
                                           or (action_by_id is not null and action_dtime is not null)),
              version_nbr integer not null
);
create index dk_reliefrqst_1 on reliefrqst(agency_id,request_date);
create index dk_reliefrqst_2 on reliefrqst(request_date,status_code);
create index dk_reliefrqst_3 on reliefrqst(status_code,urgency_ind);
