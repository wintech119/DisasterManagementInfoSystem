We must drop and recreate the donation table so it matches the target DDL below, while:

Preserving all existing data in donation

Retaining full referential integrity with all related tables

Not breaking any logic, UI, workflow, or behaviour

Not weakening or changing any security fixes (CSP, CSRF, auth/RBAC, cookies, sessions)

Not changing any other table schemas, except for temporary FK drops/re-adds where strictly necessary

üéØ TARGET DDL (FINAL donation TABLE SHAPE)

After the migration, the donation table must conform to this exact structure:

create table donation
(
	donation_id integer not null generated by default as identity
		constraint pk_donation primary key,

	--Donor and description of donation received
	donor_id integer not null
		constraint fk_donation_donor references donor,
	donation_desc text not null,

	origin_country_id smallint not null
		constraint fk_donation_country references country,
	origin_address1_text varchar(255),
	origin_address2_text varchar(255),

	--Event for which donation was made. Default to ADHOC.
	event_id integer not null
		constraint fk_donation_event references event,
	
	--Agency that collected donation and date of collection
	custodian_id integer not null
		constraint fk_donation_custodian references custodian,

	received_date date not null
		constraint c_donation_1 check (received_date <= CURRENT_DATE),

	--Sum of item cost over all items cost(s) and funds donated
	tot_item_cost decimal(12,2) not null
		constraint c_donation_2 check (tot_item_cost >= 0.00),

	storage_cost decimal(12,2) not null
		constraint c_donation_2a check (storage_cost >= 0.00),

	haulage_cost decimal(12,2) not null
		constraint c_donation_2b check (haulage_cost >= 0.00),

	--Other costs
	other_cost decimal(12,2) not null
		constraint c_donation_2c check (other_cost >= 0.00),

	--Description of other costs incurred
	other_cost_desc varchar(255),

	status_code char(1) not null
		--E=Entered, V=Verified, P=Processed
		constraint c_donation_3 check (status_code in ('E','V','P')),

	--Any comments related to the receipt of donation
	comments_text text,

	create_by_id varchar(20) not null,
	create_dtime timestamp(0) without time zone not null,
	update_by_id varchar(20) not null,
	update_dtime timestamp(0) without time zone not null,
	verify_by_id varchar(20) not null,
	verify_dtime timestamp(0) without time zone not null,
	version_nbr integer not null
);

üö® HARD CONSTRAINTS ‚Äî DO NOT VIOLATE

Retain referential integrity

Before touching the table, detect all foreign keys that reference donation(donation_id). Typical ones include:

donation_item.donation_id ‚Üí donation.donation_id

dnintake.donation_id ‚Üí donation.donation_id

donation_doc.donation_id ‚Üí donation.donation_id

Any other FK found in /mnt/data/drms-2.2.sql

You may temporarily drop these FKs, but you must recreate them exactly after the new donation table is in place.

No orphan rows may be created.

Do NOT break any app logic, UI or workflows

All donation-related flows must continue to work exactly as before:

Creating and editing donations

Accepting donations and adding donation items

Donation intake (dnintake, dnintake_item)

Donation document attachments (donation_doc)

Any dashboards or reports using donation

Column names and meanings must remain consistent with how the application currently uses them.

Do NOT modify security configuration

Do not change:

CSP configuration

CSRF setup

Authentication/authorization settings

Cookie/session handling

Flask routes or templates

This is a DB-only schema migration.

Preserve all data in donation

Even though we are ‚Äúdropping and creating‚Äù, this must be done via a safe shadow-table strategy so that:

All existing rows in donation are preserved

donation_id values remain the same (so FKs remain consistent)