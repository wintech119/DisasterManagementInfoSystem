create table reliefrqst_item
(
	reliefrqst_id integer not null
		constraint fk_reliefrqst_item_reliefrqst references reliefrqst,

	item_id integer not null
		constraint fk_reliefrqst_item_item references item,

	request_qty decimal(12,2) not null
		constraint c_reliefrqst_item_1 check (request_qty > 0.00),

	issue_qty decimal(12,2) not null
		constraint c_reliefrqst_item_2a
			check ((status_code in ('R','U','W','D') and issue_qty = 0)
				or (status_code in ('P','L') and issue_qty < request_qty)
				or (status_code in ('F') and issue_qty = request_qty)),

	urgency_ind char(1) not null
		constraint c_reliefrqst_item_3 check (urgency_ind in ('L','M','H','C')),

	--Reason for requested item is required if urgency is above medium
	rqst_reason_desc varchar(255)
		constraint c_reliefrqst_item_4
		check ((rqst_reason_desc is not null)
			or (rqst_reason_desc is null and urgency_ind in ('L','M'))),

	--Where urgency for item is indicated as High or Critical, date required is mandatory.
	required_by_date date
		constraint c_reliefrqst_item_5
		check ((required_by_date is not null)
			or (required_by_date is null and urgency_ind in ('L','M'))),

	status_code char(1) not null default 'R'
			--R=Requested, U=Unavailable, W=Awaiting availability,
			--'D'=Denied, P=Partly filled, L=Allowed limit, F=Filled, A=Draft
		--constraint c_reliefrqst_item_6a
		--check (status_code in ('R','U','W','D','P','L','F')),
		constraint fk_reliefrqst_item_reliefrqstitem_status references reliefrqstitem_status,

	--Reason is required where item requested is denied/limited by ODPEM
	status_reason_desc varchar(255)
		constraint c_reliefrqst_item_6b
		check ((status_reason_desc is not null)
			or (status_reason_desc is null and status_code not in ('D','L'))),

	action_by_id varchar(20)
		constraint c_reliefrqst_item_7
		check ((action_by_id is null and status_code = 'R') 
			or (action_by_id is not null and status_code != 'R')),
	action_dtime timestamp(0) without time zone
		constraint c_reliefrqst_item_8
		check ((action_by_id is null and action_dtime is null) 
			or (action_by_id is not null and action_dtime is not null)),
	version_nbr integer not null,
	constraint pk_reliefrqst_item primary key(reliefrqst_id,item_id)
);
create index dk_reliefrqst_item_2 on reliefrqst_item(item_id,urgency_ind);

--Assumption: Only usable items will be distributed. The quantity available for distribution is
--the item's usable quantity minus the reserved quantity. Verification of a distribution must reduce
--the usable quantity by the quantity distributed, and increment the reserved quantity by the same
--quantity.

--
----Relief packages for delivery to agencies (relief handout sites) for the needy.
--
create table reliefpkg
(
	reliefpkg_id integer not null generated by default as identity
		constraint pk_reliefpkg primary key,

	--Target agency for delivery of relief package
	agency_id integer not null
		constraint fk_reliefpkg_agency references agency,

	--Randomly generated reference/tracking number for relief package
	tracking_no char(7) not null,

	--Event for which relief was requested by agency (and
	--for which it is eligible for relief)
	eligible_event_id integer
		constraint fk_reliefpkg_event references event,

	--Target inventory (of agency) into which items will be kept							 
	to_inventory_id integer not null
		constraint fk_reliefpkg_warehouse references warehouse(warehouse_id),

	--Identifier of the request for which the package is created						   
	reliefrqst_id integer not null
		constraint fk_reliefpkg_reliefrqst references reliefrqst,

	--Date on which packaging started
	start_date date not null default CURRENT_DATE
		constraint c_reliefpkg_1 check (start_date <= CURRENT_DATE),

	--Date on which package was dispatched.
	dispatch_dtime timestamp(0) without time zone
		constraint c_reliefpkg_2
		check ((dispatch_dtime is null and status_code != 'D')
			or (dispatch_dtime is null and status_code = 'D')),

	--Mode(s) of transport for package from source inventories
	transport_mode varchar(255),

	comments_text varchar(255),

	status_code char(1) not null
		--Status of reliefpkg transaction:
		--A=Draft, P=Processing, C=Completed, V=Verified, D=Dispatched, R=Received
		constraint c_reliefpkg_3 check (status_code in ('A','P','C','V','D','R')),

	create_by_id varchar(20) not null,
	create_dtime timestamp(0) without time zone not null,
	update_by_id varchar(20) not null,
	update_dtime timestamp(0) without time zone,
	verify_by_id varchar(20) not null,
	verify_dtime timestamp(0) without time zone,
	received_by_id varchar(20) not null,
	received_dtime timestamp(0) without time zone,
	version_nbr integer not null
);
--Indexes to retrieve reliefpkg by date, source and destination Inventories
create index dk_reliefpkg_1 on reliefpkg(start_date);
create index dk_reliefpkg_3 on reliefpkg(to_inventory_id);